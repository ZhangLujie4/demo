---
title: MongoDB 聚合分析
date: 2018-03-25 19:21:10
tags: mongodb 
categories: MongoDB
---

```
今天看了关于mongodb的聚合方面，这时所做出的总结。
聚合操作能够处理数据记录并且返回计算结果。
聚合操作能够将多个文档中的值组合起来，对成组数据执行各种操作，返回单一的结果。
它相当于SQL中的count（*）组合group by
```
<!-- more -->

# aggregate()方法

对于MongoDB中的聚合操作，应该使用`aggregate()`方法

### 1、聚合表达式

```
语法为:
db.collection.aggregate(pipeline, options)
具体应用举例为：
db.demo.aggregate([{$group:{_id:"$<key>",num_movie:{$sum:2}}}])
$<key>代表用来分组的key，num_movie为新生成的key，步长为2
(key值若为value，成组个数为n)则返回文档类型为
{
	<key> : value,
	num_movie : 2*n
}
```
| 表达式      | 描述                                                         |
| ----------- | ------------------------------------------------------------ |
| `$sum`      | 对集合所有文档的定义值进行加和操作                           |
| `$avg`      | 对集合中所有文档的定义值进行平均值                           |
| `$min`      | 计算集合中所有文档的对应值中的最小值                         |
| `$max`      | 计算集合中所有文档的对应值中的最大值                         |
| `$push`     | 将值插入到一个结果文档的数组中                               |
| `$addToSet` | 将值插入到一个结果文档的数组中，但不进行复制                 |
| `$first`    | 根据成组方式，从源文档中获取第一个文档。但只有对之前应用过 `$sort` 管道操作符的结果才有意义。 |
| `$last`     | 根据成组方式，从源文档中获取最后一个文档。但只有对之前进行过 `$sort` 管道操作符的结果才有意义。 |

### 2、管道的概念

```
管道（pipeline）概念指能够在一些输入上执行一个操作，操作结束的返db回结果能用作下一个命令的输入。
```

MongoDB的聚合架构中能够采取的管道操作符有：

- **$project** 用来选取集合中一些特定字段。
- **$match** 过滤操作。减少用作下一阶段输入的文档的数量。
- **$group** 如上所述，执行真正的聚合操作。
- **$sort** 对文档进行排序。
- **$skip** 在一组文档中，跳过指定数量的文档。
- **$limit** 将查看文档的数目限制为从当前位置处开始的指定数目。
- **$unwind** 解开使用数组的文档。当使用数组时，数据处于预连接状态，通过该操作，数据重新回归为各个单独的文档的状态。

### 3、聚合中的游标

```
db.collection.aggregate()方法可以返回一个指针（cursor），数据放在内存中，直接操作。跟Mongo shell 一样指针操作。
```

